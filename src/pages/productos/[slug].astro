---
import MainLayout from '../../layouts/MainLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ProductCard from '../../components/ProductCard.astro';
import AddToQuoteBtn from '../../components/islands/AddToQuoteBtn.tsx';
import VariantSelector from '../../components/islands/VariantSelector.tsx';
import ImageGallery from '../../components/islands/ImageGallery.tsx';
import RecentlyViewed from '../../components/islands/RecentlyViewed.tsx';
import { getCollection } from 'astro:content';
import { siteConfig } from '../../data/site-config';
import { slugify } from '../../utils/slugify';
import { applicationTags } from '../../data/application-tags';
import { complementaryCategories } from '../../data/complementary-categories';
import { getCategoryPlaceholderSvg } from '../../utils/category-placeholders';

export async function getStaticPaths() {
  const products = await getCollection('products');
  return products.map(product => {
    const sameCategory = products.filter(
      p => p.data.categorySlug === product.data.categorySlug && p.data.sku !== product.data.sku
    );
    const sorted = [...sameCategory].sort((a, b) => a.data.sku.localeCompare(b.data.sku));
    let related = sorted.slice(0, 4);

    if (related.length < 3) {
      const otherCategory = products.filter(
        p => p.data.categorySlug !== product.data.categorySlug && p.data.sku !== product.data.sku
      );
      const otherSorted = [...otherCategory].sort((a, b) => a.data.sku.localeCompare(b.data.sku));
      related = [...related, ...otherSorted.slice(0, 4 - related.length)];
    }

    // Complementary products from related categories
    const compCategorySlugs = complementaryCategories[product.data.categorySlug] || [];
    const complementary = products
      .filter(p => compCategorySlugs.includes(p.data.categorySlug) && p.data.sku !== product.data.sku)
      .sort((a, b) => a.data.sku.localeCompare(b.data.sku))
      .slice(0, 4);

    return {
      params: { slug: slugify(product.data.title) },
      props: {
        product: product.data,
        relatedProducts: related.map(p => p.data),
        complementaryProducts: complementary.map(p => p.data),
      },
    };
  });
}

const { product, relatedProducts, complementaryProducts } = Astro.props;
const specsEntries = Object.entries(product.specs);
const allImages = [
  ...(product.image ? [product.image] : []),
  ...(product.images || []),
];
const tags = applicationTags[product.categorySlug] || [];
const productSlug = slugify(product.title);
---

<MainLayout title={`${product.title} — GelChile`} description={product.description}>
  {/* JSON-LD Product schema for Google Shopping / Rich Results */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Product",
    "name": product.title,
    "description": product.description,
    "sku": product.sku,
    "url": `${siteConfig.url}/productos/${slugify(product.title)}`,
    "image": allImages.length > 0 ? allImages.map(img => `${siteConfig.url}${img}`) : undefined,
    "brand": {
      "@type": "Brand",
      "name": "GelChile"
    },
    "category": product.category,
    "offers": {
      "@type": "Offer",
      "url": `${siteConfig.url}/productos/${slugify(product.title)}`,
      "availability": product.inStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
      "priceCurrency": "CLP",
      "price": "0",
      "priceValidUntil": new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      "seller": {
        "@type": "Organization",
        "name": "GelChile"
      }
    }
  })} />

  <div class="detail-header-offset">
    <div class="detail-hero-breadcrumb">
      <Breadcrumb items={[
        { label: 'Inicio', href: '/' },
        { label: 'Productos', href: '/productos' },
        { label: product.title },
      ]} />
    </div>
  </div>

  <!-- Product Detail -->
  <section class="section product-detail" data-product-sku={product.sku} data-product-title={product.title} data-product-image={product.image || ''} data-product-categoryslug={product.categorySlug}>
    <div class="container">
      <div class="back-link-top" data-aos="fade-right">
        <a href="/productos" class="back-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Volver al Catálogo
        </a>
      </div>
      <div class="product-detail-grid">
        <!-- Image Column -->
        <div class="product-detail-image" data-aos="fade-right">
          {allImages.length > 0 ? (
            <ImageGallery client:visible images={allImages} alt={product.title} badge={product.badge} />
          ) : (
            <>
              {product.badge && <span class="detail-badge">{product.badge}</span>}
              <div class="detail-image-wrapper">
                <Fragment set:html={getCategoryPlaceholderSvg(product.categorySlug)} />
              </div>
            </>
          )}
          <div class:list={['detail-stock', { 'out-stock': !product.inStock }]}>
            <span class="stock-dot"></span>
            {product.inStock ? 'En Stock' : 'Sin Stock'}
          </div>
        </div>

        <!-- Info Column -->
        <div class="product-detail-info" data-aos="fade-left" data-aos-delay="100">
          <span class="detail-category">{product.category}</span>
          {tags.length > 0 && (
            <div class="detail-app-tags">
              {tags.map((tag) => (
                <span class="detail-app-tag">{tag}</span>
              ))}
            </div>
          )}
          <h1 class="detail-title">{product.title}</h1>
          <p class="detail-sku">SKU: {product.sku}</p>
          <p class="detail-description">{product.description}</p>

          <div class="detail-actions">
            {product.variants && product.variants.length > 0 && product.inStock ? (
              <VariantSelector
                client:visible
                sku={product.sku}
                title={product.title}
                category={product.category}
                image={product.image}
                variants={product.variants}
              />
            ) : (
              <AddToQuoteBtn
                client:visible
                sku={product.sku}
                title={product.title}
                category={product.category}
                image={product.image}
                inStock={product.inStock}
              />
            )}
          </div>
        </div>
      </div>

      <!-- Stat Cards: Key Specs Highlights -->
      {specsEntries.length > 0 && (
        <div class="stat-cards-section" data-aos="fade-up" data-aos-delay="150">
          <div class="stat-cards-grid">
            {specsEntries.slice(0, 4).map(([label, value]) => (
              <div class="product-stat-card">
                <span class="stat-card-label">{label}</span>
                <span class="stat-card-value">{value}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Tabs: Specs & Features -->
      {(specsEntries.length > 0 || product.features.length > 0) && (
        <div class="product-tabs-wrapper" data-aos="fade-up" data-aos-delay="200">
          <div class="tabs-header" role="tablist">
            {specsEntries.length > 0 && (
              <button
                class="tab-btn active"
                role="tab"
                aria-selected="true"
                aria-controls="panel-specs"
                id="tab-specs"
                data-tab="specs"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2" />
                  <rect x="9" y="3" width="6" height="4" rx="1" />
                  <path d="M9 12h6M9 16h6" />
                </svg>
                Especificaciones Técnicas
              </button>
            )}
            {product.features.length > 0 && (
              <button
                class:list={['tab-btn', { active: specsEntries.length === 0 }]}
                role="tab"
                aria-selected={specsEntries.length === 0 ? 'true' : 'false'}
                aria-controls="panel-features"
                id="tab-features"
                data-tab="features"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                Características
              </button>
            )}
          </div>

          {specsEntries.length > 0 && (
            <div class="tab-panel active" role="tabpanel" id="panel-specs" aria-labelledby="tab-specs">
              <div class="specs-table">
                {specsEntries.map(([label, value]) => (
                  <div class="spec-row">
                    <span class="spec-label">{label}</span>
                    <span class="spec-value">{value}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {product.features.length > 0 && (
            <div class:list={['tab-panel', { active: specsEntries.length === 0 }]} role="tabpanel" id="panel-features" aria-labelledby="tab-features">
              <ul class="features-list">
                {product.features.map((feature) => (
                  <li>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" width="20" height="20">
                      <polyline points="20 6 9 17 4 12" />
                    </svg>
                    <span>{feature}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}

      <!-- Trust Indicators -->
      <div class="trust-section" data-aos="fade-up">
        <div class="trust-indicators">
          <div class="trust-card" data-aos="fade-up" data-aos-delay="100">
            <div class="trust-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" aria-hidden="true">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
            </div>
            <div class="trust-card-text">
              <strong>+20 Años</strong>
              <span>de Experiencia</span>
            </div>
          </div>
          <div class="trust-card" data-aos="fade-up" data-aos-delay="200">
            <div class="trust-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" aria-hidden="true">
                <polyline points="9 11 12 14 22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
              </svg>
            </div>
            <div class="trust-card-text">
              <strong>IEEE 80 / NEC</strong>
              <span>Normas Certificadas</span>
            </div>
          </div>
          <div class="trust-card" data-aos="fade-up" data-aos-delay="300">
            <div class="trust-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" aria-hidden="true">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
              </svg>
            </div>
            <div class="trust-card-text">
              <strong>Asesoría Técnica</strong>
              <span>Especializada</span>
            </div>
          </div>
          <div class="trust-card" data-aos="fade-up" data-aos-delay="400">
            <div class="trust-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" aria-hidden="true">
                <rect x="1" y="3" width="15" height="13" rx="2"/>
                <path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/>
                <circle cx="5.5" cy="18.5" r="2.5"/>
                <circle cx="18.5" cy="18.5" r="2.5"/>
              </svg>
            </div>
            <div class="trust-card-text">
              <strong>Despacho</strong>
              <span>a Todo Chile</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recently Viewed -->
      <RecentlyViewed client:visible currentSku={product.sku} />

      <!-- Related Products -->
      {relatedProducts.length > 0 && (
        <div class="related-products">
          <h2 class="related-title" data-aos="fade-up">También te puede interesar</h2>
          <div class="related-grid">
            {relatedProducts.map((rp, i) => (
              <ProductCard
                sku={rp.sku}
                title={rp.title}
                category={rp.category}
                categorySlug={rp.categorySlug}
                description={rp.description}
                image={rp.image}
                badge={rp.badge}
                inStock={rp.inStock}
                delay={(i % 4) * 100}
                imageCount={(rp.image ? 1 : 0) + (rp.images?.length ?? 0)}
                hasVariants={(rp.variants?.length ?? 0) > 0}
              />
            ))}
          </div>
        </div>
      )}

      <!-- Complementary Products -->
      {complementaryProducts.length > 0 && (
        <div class="related-products complementary-products">
          <h2 class="related-title" data-aos="fade-up">Productos Complementarios</h2>
          <div class="related-grid">
            {complementaryProducts.map((cp, i) => (
              <ProductCard
                sku={cp.sku}
                title={cp.title}
                category={cp.category}
                categorySlug={cp.categorySlug}
                description={cp.description}
                image={cp.image}
                badge={cp.badge}
                inStock={cp.inStock}
                delay={(i % 4) * 100}
                imageCount={(cp.image ? 1 : 0) + (cp.images?.length ?? 0)}
                hasVariants={(cp.variants?.length ?? 0) > 0}
              />
            ))}
          </div>
        </div>
      )}

      <!-- Back Link -->
      <div class="back-link">
        <a href="/productos" class="btn btn-secondary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" width="18" height="18">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Volver al Catálogo
        </a>
      </div>
    </div>
  </section>
</MainLayout>

<script>
  // Tabs logic
  document.querySelectorAll('.tab-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const tabId = (btn as HTMLElement).dataset.tab;
      // Deactivate all tabs
      document.querySelectorAll('.tab-btn').forEach((b) => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.tab-panel').forEach((p) => {
        p.classList.remove('active');
      });
      // Activate clicked tab
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      const panel = document.getElementById(`panel-${tabId}`);
      if (panel) panel.classList.add('active');
    });
  });

  // Register product view
  import { addViewed, initRecentlyViewed } from '../../stores/recentlyViewed';
  import { slugify } from '../../utils/slugify';
  initRecentlyViewed();
  const detail = document.querySelector('[data-product-sku]') as HTMLElement | null;
  if (detail) {
    addViewed({
      sku: detail.dataset.productSku!,
      title: detail.dataset.productTitle!,
      image: detail.dataset.productImage || null,
      categorySlug: detail.dataset.productCategoryslug!,
      slug: slugify(detail.dataset.productTitle!),
    });
  }
</script>

<style>
  /* Mini hero header with blue gradient (this page has no page-hero) */
  .detail-header-offset {
    padding-top: 72px;
    background: linear-gradient(135deg, var(--color-gray-900) 0%, var(--color-primary-dark) 60%, var(--color-primary) 100%);
  }

  .detail-hero-breadcrumb :global(.breadcrumb) {
    background: transparent;
    border-bottom: none;
  }

  .detail-hero-breadcrumb :global(.breadcrumb-item) {
    color: rgba(255, 255, 255, 0.7);
  }

  .detail-hero-breadcrumb :global(.breadcrumb-item a) {
    color: rgba(255, 255, 255, 0.8);
  }

  .detail-hero-breadcrumb :global(.breadcrumb-item a:hover) {
    color: #ffffff;
  }

  .detail-hero-breadcrumb :global(.breadcrumb-item.active) {
    color: #ffffff;
  }

  .detail-hero-breadcrumb :global(.breadcrumb-separator) {
    color: rgba(255, 255, 255, 0.4);
  }

  /* Back Link Top */
  .back-link-top {
    margin-bottom: var(--spacing-6);
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary);
    background: var(--color-primary-50);
    padding: var(--spacing-2) var(--spacing-4);
    border-radius: var(--radius-full);
    transition: background var(--transition-fast), color var(--transition-fast);
  }

  .back-btn:hover {
    background: var(--color-primary);
    color: var(--color-white);
  }

  .back-btn svg {
    transition: transform var(--transition-fast);
  }

  .back-btn:hover svg {
    transform: translateX(-3px);
  }

  /* Product Detail Grid */
  .product-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-10);
    align-items: start;
  }

  /* Image Column */
  .product-detail-image {
    position: relative;
    background: linear-gradient(145deg, var(--color-primary-50) 0%, var(--color-gray-50) 100%);
    border-radius: var(--radius-xl);
    overflow: hidden;
    border: 1px solid var(--color-primary-100);
  }

  .detail-image-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    padding: var(--spacing-8);
  }

  .detail-image-wrapper img {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
  }

  .detail-placeholder {
    width: 120px;
    height: 120px;
    color: var(--color-gray-400);
  }

  .detail-badge {
    position: absolute;
    top: var(--spacing-4);
    left: var(--spacing-4);
    background: var(--color-primary);
    color: var(--color-white);
    padding: var(--spacing-1) var(--spacing-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    z-index: 1;
  }

  .detail-stock {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-4);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-success);
    border-top: 1px solid var(--color-primary-100);
  }

  .detail-stock.out-stock {
    color: var(--color-gray-400);
  }

  .stock-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    background: currentColor;
    animation: pulse 2s ease-in-out infinite;
  }

  .detail-stock.out-stock .stock-dot {
    animation: none;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Info Column */
  .product-detail-info {
    padding-top: var(--spacing-2);
  }

  .detail-category {
    display: inline-block;
    padding: var(--spacing-1) var(--spacing-3);
    background: rgba(0, 82, 204, 0.08);
    color: var(--color-primary);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--spacing-3);
  }

  .detail-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    line-height: 1.2;
    margin-bottom: var(--spacing-2);
  }

  .detail-sku {
    font-size: var(--font-size-sm);
    color: var(--color-gray-400);
    margin-bottom: var(--spacing-4);
  }

  .detail-description {
    font-size: var(--font-size-base);
    color: var(--color-gray-600);
    line-height: 1.7;
    margin-bottom: var(--spacing-6);
  }

  .detail-actions {
    margin-top: var(--spacing-4);
  }

  /* Application Tags on detail */
  .detail-app-tags {
    display: flex;
    gap: var(--spacing-2);
    margin-bottom: var(--spacing-3);
    flex-wrap: wrap;
  }

  .detail-app-tag {
    display: inline-block;
    padding: 2px 10px;
    background: var(--color-gray-100);
    color: var(--color-gray-600);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-full);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  /* Stat Cards */
  .stat-cards-section {
    margin-top: var(--spacing-10);
  }

  .stat-cards-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-4);
  }

  .product-stat-card {
    background: var(--color-surface-card);
    border: 1px solid var(--color-primary-100);
    border-radius: var(--radius-lg);
    padding: var(--spacing-5) var(--spacing-4);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .product-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .stat-card-label {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stat-card-value {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Complementary Products */
  .complementary-products {
    margin-top: var(--spacing-8);
  }

  /* Recently Viewed (global for Preact island) */
  :global(.recently-viewed-section) {
    margin-top: var(--spacing-12);
  }

  :global(.recently-viewed-title) {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    text-align: center;
    margin-bottom: var(--spacing-6);
  }

  :global(.recently-viewed-grid) {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-4);
  }

  :global(.recently-viewed-card) {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-3);
    background: var(--color-surface-card);
    border: 1px solid var(--color-gray-100);
    border-radius: var(--radius-lg);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    color: inherit;
    text-decoration: none;
  }

  :global(.recently-viewed-card:hover) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  :global(.rv-image) {
    width: 60px;
    height: 60px;
    flex-shrink: 0;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-gray-50);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.rv-image img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  :global(.rv-image svg) {
    color: var(--color-gray-400);
  }

  :global(.rv-title) {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-gray-800);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  :global([data-theme="dark"] .recently-viewed-title) {
    color: #ffffff;
  }

  :global([data-theme="dark"] .recently-viewed-card) {
    background: #1e293b;
    border-color: #334155;
  }

  :global([data-theme="dark"] .recently-viewed-card:hover) {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  :global([data-theme="dark"] .rv-image) {
    background: #334155;
  }

  :global([data-theme="dark"] .rv-title) {
    color: #e2e8f0;
  }

  /* Tabs Container */
  .product-tabs-wrapper {
    margin-top: var(--spacing-12);
    background: var(--color-primary-50);
    border-radius: var(--radius-xl);
    overflow: hidden;
    border: 1px solid var(--color-primary-100);
  }

  /* Tabs Header */
  .tabs-header {
    display: flex;
    border-bottom: 2px solid var(--color-primary-100);
    background: linear-gradient(135deg, rgba(0, 82, 204, 0.06) 0%, rgba(0, 82, 204, 0.02) 100%);
  }

  .tab-btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-2);
    padding: var(--spacing-4) var(--spacing-6);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-500);
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    transition: color var(--transition-fast), border-color var(--transition-fast), background var(--transition-fast);
    white-space: nowrap;
  }

  .tab-btn:hover {
    color: var(--color-primary);
    background: rgba(0, 82, 204, 0.04);
  }

  .tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
    background: rgba(0, 82, 204, 0.06);
  }

  .tab-btn svg {
    flex-shrink: 0;
  }

  /* Tab Panels */
  .tab-panel {
    display: none;
    padding: var(--spacing-8);
  }

  .tab-panel.active {
    display: block;
  }

  /* Specs Table (inside tab) */
  .specs-table {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border: 1px solid var(--color-primary-100);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-white);
  }

  .spec-row {
    display: contents;
  }

  .spec-label,
  .spec-value {
    padding: var(--spacing-3) var(--spacing-4);
    border-bottom: 1px solid var(--color-primary-50);
  }

  .spec-label {
    font-weight: var(--font-weight-semibold);
    color: var(--color-primary-dark);
    background: rgba(0, 82, 204, 0.05);
    font-size: var(--font-size-sm);
  }

  .spec-value {
    color: var(--color-gray-900);
    font-size: var(--font-size-sm);
  }

  .spec-row:last-child .spec-label,
  .spec-row:last-child .spec-value {
    border-bottom: none;
  }

  /* Features List (inside tab) */
  .features-list {
    list-style: none;
    padding: 0;
    display: grid;
    gap: var(--spacing-3);
  }

  .features-list li {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-3);
    font-size: var(--font-size-base);
    color: var(--color-gray-700);
    line-height: 1.5;
  }

  .features-list li svg {
    flex-shrink: 0;
    color: var(--color-primary);
    margin-top: 2px;
  }

  /* Back Link */
  .back-link {
    margin-top: var(--spacing-12);
    text-align: center;
  }

  .back-link a {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  /* Dark mode */
  :global([data-theme="dark"]) .detail-header-offset {
    background: linear-gradient(135deg, #0a1628 0%, var(--color-primary-dark) 60%, #1e3a8a 100%);
  }

  :global([data-theme="dark"]) .back-btn {
    background: rgba(76, 154, 255, 0.15);
    color: var(--color-primary-light);
  }

  :global([data-theme="dark"]) .back-btn:hover {
    background: var(--color-primary);
    color: #ffffff;
  }

  :global([data-theme="dark"]) .product-detail-image {
    background: linear-gradient(145deg, rgba(76, 154, 255, 0.08) 0%, rgba(30, 41, 59, 0.5) 100%);
    border-color: rgba(76, 154, 255, 0.2);
  }

  :global([data-theme="dark"]) .detail-stock {
    border-top-color: rgba(76, 154, 255, 0.2);
  }

  :global([data-theme="dark"]) .product-tabs-wrapper {
    background: rgba(76, 154, 255, 0.06);
    border-color: rgba(76, 154, 255, 0.15);
  }

  :global([data-theme="dark"]) .tabs-header {
    border-bottom-color: rgba(76, 154, 255, 0.15);
    background: linear-gradient(135deg, rgba(76, 154, 255, 0.08) 0%, rgba(76, 154, 255, 0.02) 100%);
  }

  :global([data-theme="dark"]) .tab-btn {
    color: rgba(255, 255, 255, 0.5);
  }

  :global([data-theme="dark"]) .tab-btn:hover {
    color: var(--color-primary-light);
    background: rgba(76, 154, 255, 0.08);
  }

  :global([data-theme="dark"]) .tab-btn.active {
    color: var(--color-primary-light);
    border-bottom-color: var(--color-primary-light);
    background: rgba(76, 154, 255, 0.1);
  }

  :global([data-theme="dark"]) .specs-table {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(76, 154, 255, 0.2);
  }

  :global([data-theme="dark"]) .spec-label {
    background: rgba(76, 154, 255, 0.08);
    color: #93bbfc;
  }

  :global([data-theme="dark"]) .spec-label,
  :global([data-theme="dark"]) .spec-value {
    border-bottom-color: rgba(76, 154, 255, 0.1);
  }

  :global([data-theme="dark"]) .features-list li svg {
    color: var(--color-primary-light);
  }

  /* Dark mode - stat cards, tags */
  :global([data-theme="dark"]) .product-stat-card {
    background: rgba(30, 41, 59, 0.6);
    border-color: rgba(76, 154, 255, 0.2);
  }

  :global([data-theme="dark"]) .product-stat-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  :global([data-theme="dark"]) .stat-card-label {
    color: #60a5fa;
  }

  :global([data-theme="dark"]) .stat-card-value {
    color: #e2e8f0;
  }

  :global([data-theme="dark"]) .detail-app-tag {
    background: rgba(76, 154, 255, 0.1);
    color: #94a3b8;
  }

  /* Trust Section */
  .trust-section {
    margin-top: var(--spacing-12);
    padding: var(--spacing-8) var(--spacing-6);
    background: linear-gradient(135deg, var(--color-primary-50) 0%, rgba(0, 82, 204, 0.03) 100%);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-primary-100);
  }

  .trust-indicators {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-6);
  }

  .trust-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    justify-content: center;
  }

  .trust-card-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    color: #ffffff;
  }

  .trust-card-icon svg {
    width: 24px;
    height: 24px;
  }

  .trust-card-text {
    display: flex;
    flex-direction: column;
  }

  .trust-card-text strong {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    line-height: 1.3;
  }

  .trust-card-text span {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
    line-height: 1.3;
  }

  /* Related Products */
  .related-products {
    margin-top: var(--spacing-12);
  }

  .related-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    text-align: center;
    margin-bottom: var(--spacing-8);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--spacing-6);
  }

  /* Dark mode - Trust & Related */
  :global([data-theme="dark"]) .trust-section {
    background: linear-gradient(135deg, rgba(76, 154, 255, 0.08) 0%, rgba(76, 154, 255, 0.02) 100%);
    border-color: rgba(76, 154, 255, 0.15);
  }

  :global([data-theme="dark"]) .trust-card-icon {
    background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
  }

  :global([data-theme="dark"]) .trust-card-text strong {
    color: #e2e8f0;
  }

  :global([data-theme="dark"]) .trust-card-text span {
    color: #94a3b8;
  }

  :global([data-theme="dark"]) .related-title {
    color: #ffffff;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .detail-header-offset {
      padding-top: 64px;
    }

    .trust-indicators {
      grid-template-columns: 1fr;
    }

    .trust-card {
      justify-content: flex-start;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .stat-cards-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-3);
    }

    .product-stat-card {
      padding: var(--spacing-4) var(--spacing-3);
    }

    .stat-card-value {
      font-size: var(--font-size-sm);
    }

    :global(.recently-viewed-grid) {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 1024px) {
    .trust-indicators {
      grid-template-columns: repeat(2, 1fr);
    }

    .related-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .stat-cards-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    :global(.recently-viewed-grid) {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .product-detail-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-6);
    }

    .detail-image-wrapper {
      min-height: 280px;
    }

    .detail-title {
      font-size: var(--font-size-2xl);
    }

    .tab-panel {
      padding: var(--spacing-5);
    }

    .tab-btn {
      padding: var(--spacing-3) var(--spacing-3);
      font-size: var(--font-size-sm);
      gap: var(--spacing-1);
    }

    .tab-btn svg {
      width: 16px;
      height: 16px;
    }

    .specs-table {
      grid-template-columns: 1fr;
    }

    .spec-label {
      border-bottom: none;
      padding-bottom: var(--spacing-1);
    }

    .spec-value {
      padding-top: 0;
    }
  }
</style>
