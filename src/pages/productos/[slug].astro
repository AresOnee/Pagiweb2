---
import MainLayout from '../../layouts/MainLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import AddToQuoteBtn from '../../components/islands/AddToQuoteBtn.tsx';
import VariantSelector from '../../components/islands/VariantSelector.tsx';
import ImageGallery from '../../components/islands/ImageGallery.tsx';
import { getCollection } from 'astro:content';
import { siteConfig } from '../../data/site-config';

export async function getStaticPaths() {
  const products = await getCollection('products');
  return products.map(product => ({
    params: { slug: product.data.sku.toLowerCase() },
    props: { product: product.data },
  }));
}

const { product } = Astro.props;
const specsEntries = Object.entries(product.specs);
const allImages = [
  ...(product.image ? [product.image] : []),
  ...(product.images || []),
];
---

<MainLayout title={`${product.title} — GelChile`} description={product.description}>
  {/* JSON-LD Product schema for Google Shopping / Rich Results */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Product",
    "name": product.title,
    "description": product.description,
    "sku": product.sku,
    "url": `${siteConfig.url}/productos/${product.sku.toLowerCase()}`,
    "image": allImages.length > 0 ? allImages.map(img => `${siteConfig.url}${img}`) : undefined,
    "brand": {
      "@type": "Brand",
      "name": "GelChile"
    },
    "category": product.category,
    "offers": {
      "@type": "Offer",
      "url": `${siteConfig.url}/productos/${product.sku.toLowerCase()}`,
      "availability": product.inStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock",
      "priceCurrency": "CLP",
      "price": "0",
      "priceValidUntil": new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      "seller": {
        "@type": "Organization",
        "name": "GelChile"
      }
    }
  })} />

  <Breadcrumb items={[
    { label: 'Inicio', href: '/' },
    { label: 'Productos', href: '/productos' },
    { label: product.title },
  ]} />

  <!-- Product Detail -->
  <section class="section product-detail">
    <div class="container">
      <div class="back-link-top">
        <a href="/productos" class="back-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Volver al Catálogo
        </a>
      </div>
      <div class="product-detail-grid">
        <!-- Image Column -->
        <div class="product-detail-image">
          {allImages.length > 0 ? (
            <ImageGallery client:visible images={allImages} alt={product.title} badge={product.badge} />
          ) : (
            <>
              {product.badge && <span class="detail-badge">{product.badge}</span>}
              <div class="detail-image-wrapper">
                <svg viewBox="0 0 120 120" fill="none" stroke="currentColor" strokeWidth="1" aria-hidden="true" class="detail-placeholder">
                  <rect x="30" y="20" width="60" height="80" rx="8" fill="#f1f5f9" stroke="#cbd5e1" />
                  <circle cx="60" cy="50" r="15" fill="#e2e8f0" stroke="#94a3b8" />
                  <path d="M50 75h20" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" />
                </svg>
              </div>
            </>
          )}
          <div class:list={['detail-stock', { 'out-stock': !product.inStock }]}>
            <span class="stock-dot"></span>
            {product.inStock ? 'En Stock' : 'Sin Stock'}
          </div>
        </div>

        <!-- Info Column -->
        <div class="product-detail-info">
          <span class="detail-category">{product.category}</span>
          <h1 class="detail-title">{product.title}</h1>
          <p class="detail-sku">SKU: {product.sku}</p>
          <p class="detail-description">{product.description}</p>

          <div class="detail-actions">
            {product.variants && product.variants.length > 0 && product.inStock ? (
              <VariantSelector
                client:visible
                sku={product.sku}
                title={product.title}
                category={product.category}
                image={product.image}
                variants={product.variants}
              />
            ) : (
              <AddToQuoteBtn
                client:visible
                sku={product.sku}
                title={product.title}
                category={product.category}
                image={product.image}
                inStock={product.inStock}
              />
            )}
          </div>
        </div>
      </div>

      <!-- Specs -->
      {specsEntries.length > 0 && (
        <div class="product-specs">
          <h2>Especificaciones Técnicas</h2>
          <div class="specs-table">
            {specsEntries.map(([label, value]) => (
              <div class="spec-row">
                <span class="spec-label">{label}</span>
                <span class="spec-value">{value}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Features -->
      {product.features.length > 0 && (
        <div class="product-features">
          <h2>Características</h2>
          <ul class="features-list">
            {product.features.map((feature) => (
              <li>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" width="20" height="20">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
                <span>{feature}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- Back Link -->
      <div class="back-link">
        <a href="/productos" class="btn btn-secondary">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" width="18" height="18">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Volver al Catálogo
        </a>
      </div>
    </div>
  </section>
</MainLayout>

<style>
  /* Offset breadcrumb for fixed header (this page has no page-hero) */
  :global(.breadcrumb) {
    padding-top: calc(72px + var(--spacing-4));
  }

  /* Back Link Top */
  .back-link-top {
    margin-bottom: var(--spacing-6);
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-gray-600);
    transition: color var(--transition-fast);
    padding: var(--spacing-2) 0;
  }

  .back-btn:hover {
    color: var(--color-primary);
  }

  .back-btn svg {
    transition: transform var(--transition-fast);
  }

  .back-btn:hover svg {
    transform: translateX(-3px);
  }

  /* Product Detail Grid */
  .product-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-10);
    align-items: start;
  }

  /* Image Column */
  .product-detail-image {
    position: relative;
    background: linear-gradient(145deg, var(--color-gray-50) 0%, var(--color-gray-100) 100%);
    border-radius: var(--radius-xl);
    overflow: hidden;
    border: 1px solid var(--color-gray-200);
  }

  .detail-image-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    padding: var(--spacing-8);
  }

  .detail-image-wrapper img {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
  }

  .detail-placeholder {
    width: 120px;
    height: 120px;
    color: var(--color-gray-400);
  }

  .detail-badge {
    position: absolute;
    top: var(--spacing-4);
    left: var(--spacing-4);
    background: var(--color-primary);
    color: var(--color-white);
    padding: var(--spacing-1) var(--spacing-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    z-index: 1;
  }

  .detail-stock {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    padding: var(--spacing-3) var(--spacing-4);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-success);
    border-top: 1px solid var(--color-gray-200);
  }

  .detail-stock.out-stock {
    color: var(--color-gray-400);
  }

  .stock-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    background: currentColor;
    animation: pulse 2s ease-in-out infinite;
  }

  .detail-stock.out-stock .stock-dot {
    animation: none;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Info Column */
  .product-detail-info {
    padding-top: var(--spacing-2);
  }

  .detail-category {
    display: inline-block;
    padding: var(--spacing-1) var(--spacing-3);
    background: rgba(0, 82, 204, 0.08);
    color: var(--color-primary);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--spacing-3);
  }

  .detail-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    line-height: 1.2;
    margin-bottom: var(--spacing-2);
  }

  .detail-sku {
    font-size: var(--font-size-sm);
    color: var(--color-gray-400);
    margin-bottom: var(--spacing-4);
  }

  .detail-description {
    font-size: var(--font-size-base);
    color: var(--color-gray-600);
    line-height: 1.7;
    margin-bottom: var(--spacing-6);
  }

  .detail-actions {
    margin-top: var(--spacing-4);
  }

  /* Specs Section */
  .product-specs {
    margin-top: var(--spacing-12);
  }

  .product-specs h2 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--spacing-6);
  }

  .specs-table {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .spec-row {
    display: contents;
  }

  .spec-label,
  .spec-value {
    padding: var(--spacing-3) var(--spacing-4);
    border-bottom: 1px solid var(--color-gray-100);
  }

  .spec-label {
    font-weight: var(--font-weight-semibold);
    color: var(--color-gray-600);
    background: var(--color-gray-50);
    font-size: var(--font-size-sm);
  }

  .spec-value {
    color: var(--color-gray-900);
    font-size: var(--font-size-sm);
  }

  .spec-row:last-child .spec-label,
  .spec-row:last-child .spec-value {
    border-bottom: none;
  }

  /* Features Section */
  .product-features {
    margin-top: var(--spacing-12);
  }

  .product-features h2 {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--spacing-6);
  }

  .features-list {
    list-style: none;
    padding: 0;
    display: grid;
    gap: var(--spacing-3);
  }

  .features-list li {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-3);
    font-size: var(--font-size-base);
    color: var(--color-gray-700);
    line-height: 1.5;
  }

  .features-list li svg {
    flex-shrink: 0;
    color: var(--color-success);
    margin-top: 2px;
  }

  /* Back Link */
  .back-link {
    margin-top: var(--spacing-12);
    text-align: center;
  }

  .back-link a {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-2);
  }

  /* Dark mode */
  :global([data-theme="dark"]) .back-btn:hover {
    color: #60a5fa;
  }

  /* Responsive */
  @media (max-width: 480px) {
    :global(.breadcrumb) {
      padding-top: calc(64px + var(--spacing-3));
    }
  }

  @media (max-width: 768px) {
    .product-detail-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-6);
    }

    .detail-image-wrapper {
      min-height: 280px;
    }

    .detail-title {
      font-size: var(--font-size-2xl);
    }

    .specs-table {
      grid-template-columns: 1fr;
    }

    .spec-label {
      border-bottom: none;
      padding-bottom: var(--spacing-1);
    }

    .spec-value {
      padding-top: 0;
    }
  }
</style>
